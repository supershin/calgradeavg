<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>คำนวณเกรดเฉลี่ย</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,300;0,400;1,300&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/jquery.bootstrapvalidator/0.5.0/css/bootstrapValidator.min.css">
    <link rel="stylesheet" href="css/style.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-validator/0.4.5/js/bootstrapvalidator.min.js"></script>
       
</head>

<body>
    <div class="container">

        <form class="well form-horizontal" method="post" id="calGradeform" action="">
            <fieldset>

                <!-- Form Name -->
                <legend>
                    <center>
                        <h2><b>คำนวณเกรด</b></h2>
                    </center>
                </legend><br>

                <div class="form-group">
                    <label class="col-md-4 control-label">วิชา</label>
                    <div class="col-md-4 selectContainer">
                        <div class="input-group">
                            <span class="input-group-addon"><i class="glyphicon glyphicon-list"></i></span>
                            <select id="subject" name="subject" class="form-control selectpicker">
                                <option value=" ">--- เลือกวิชา ---</option>
                                <option value="ภาษาไทย">ภาษาไทย</option>
                                <option value="คณิตศาสตร์">คณิตศาสตร์</option>
                                <option value="วิทยาศาสตร์">วิทยาศาสตร์</option>
                                <option value="สังคมศึกษา ศาสนาและวัฒนธรรม">สังคมศึกษา ศาสนาและวัฒนธรรม</option>
                                <option value="ภาษาต่างประเทศ">ภาษาต่างประเทศ</option>                                                                                               
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Text input-->
                <div class="form-group">
                    <label class="col-md-4 control-label">หน่วยกิตเดิมทั้งหมด</label>
                    <div class="col-md-4 inputGroupContainer">
                        <div class="input-group">
                            <span class="input-group-addon"><i class="glyphicon glyphicon-tags"></i></span>
                            <input id="allCredit" type="text" name="allCredit" class="form-control"
                                data-bv-numeric="true" data-bv-numeric-message="โปรดระบุเป็นตัวเลข">
                        </div>
                    </div>
                </div>

                <!-- Text input-->

                <div class="form-group">
                    <label class="col-md-4 control-label">เกรดเฉลี่ยเดิม</label>
                    <div class="col-md-4 inputGroupContainer">
                        <div class="input-group">
                            <span class="input-group-addon"><i class="glyphicon glyphicon-tags"></i></span>
                            <input id="avgGrade" name="avgGrade" class="form-control" type="text" data-bv-numeric="true"
                                data-bv-numeric-message="โปรดระบุเป็นตัวเลข">
                        </div>
                    </div>
                </div>

                <!-- Text input-->

                <div class="form-group">
                    <label class="col-md-4 control-label">หน่วยกิตใหม่</label>
                    <div class="col-md-4 inputGroupContainer">
                        <div class="input-group">
                            <span class="input-group-addon"><i class="glyphicon glyphicon-tags"></i></span>
                            <input id="newCredit" name="newCredit" class="form-control" type="text"
                                data-bv-numeric="true" data-bv-numeric-message="โปรดระบุเป็นตัวเลข">
                        </div>
                    </div>
                </div>

                <!-- Text input-->

                <div class="form-group">
                    <label class="col-md-4 control-label">เกรดเฉลี่ยที่ต้องการ</label>
                    <div class="col-md-4 inputGroupContainer">
                        <div class="input-group">
                            <span class="input-group-addon"><i class="glyphicon glyphicon-tags"></i></span>
                            <input id="goalGrade" name="goalGrade" class="form-control" type="text"
                                data-bv-numeric="true" data-bv-numeric-message="โปรดระบุเป็นตัวเลข">
                        </div>
                    </div>
                </div>

                <!-- Success message -->
                <div class="alert alert-success text-center" role="alert" id="success_message">
                    <div class="row">
                        <label class="col-md-12"><u>ผลลัพธ์</u></label>
                    </div>
                    <div class="row">
                        <label class="col-md-6 text-right">วิชา = </label>
                        <label id="lbSubject" class="col-md-6 text-left lb-result"></label>
                    </div>
                    <div class="row">
                        <label class="col-md-6 text-right">เกรดเฉลี่ยที่ต้องการ = </label>
                        <label id="lbGoalGrade" class="col-md-6 text-left lb-result"></label>
                    </div>
                    <div class="row">
                        <label class="col-md-6 text-right">เกรดที่ต้องทำ = </label>
                        <label id="lbResultGrade" class="col-md-6 text-left lb-result"></label>
                    </div>
                </div>

                <!-- Button -->
                <div class="form-group">
                    <div class="col-md-12 text-center"><button id="btnSubmit" type="submit" class="btn btn-warning">
                            <span class="glyphicon glyphicon-send"></span> คำนวณ</button>
                        <button id="btnReset" type="reset" class="btn btn-default">
                            <span class="glyphicon glyphicon-trash"></span> ล้างข้อมูล</button>
                    </div>
                </div>

            </fieldset>
        </form>
    </div>
    <div id="divTable" class="container table-responsive" style="display:none;">

        <h3>ตารางผลลัพธ์</h3>
        <table id="tblData" class="table table-hover table-bordered">
            <thead class="">
                <th class="text-center">วิชา</th>
                <th class="text-center">หน่วยกิตเดิมทั้งหมด</th>
                <th class="text-center">เกรดเฉลี่ยเดิม</th>
                <th class="text-center">หน่วยกิตใหม่</th>
                <th class="text-center">เกรดเฉลี่ยที่ต้องการ หรือทำได้</th>
                <th class="text-center">เกรดที่ต้องทำ</th>
                <th class="text-center">#</th>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    <script type="text/javascript">
        var maxGrade = 4;

        var home = {
            init: function () {

                $('#calGradeform').bootstrapValidator({
                    // To use feedback icons, ensure that you use Bootstrap v3.1.0 or later
                    feedbackIcons: {
                        valid: 'glyphicon glyphicon-ok',
                        invalid: 'glyphicon glyphicon-remove',
                        validating: 'glyphicon glyphicon-refresh'
                    },
                    fields: {
                        subject: {
                            validators: {
                                notEmpty: {
                                    message: 'โปรดระบุวิชา'
                                }
                            }
                        },
                        allCredit: {
                            validators: {
                                // stringLength: {
                                //     max: 4,
                                //     message: 'โปรดระบุหน่วยกิตเดิมทั้งหมด 3 หลัก'
                                // },
                                notEmpty: {
                                    message: 'โปรดระบุหน่วยกิตเดิมทั้งหมด'
                                },
                                between: {
                                    min: 0,
                                    max: 9999,
                                    message: 'โปรดระบุเป็นตัวเลขที่ถูกต้อง'
                                }
                            }
                        },
                        avgGrade: {
                            validators: {
                                stringLength: {
                                    max: 4,
                                },
                                notEmpty: {
                                    message: 'โปรดระบุเกรดเฉลี่ย'
                                },
                                between: {
                                    min: 0,
                                    max: 4,
                                    message: 'ค่าสูงสุดของเกรด = 4'
                                }
                            }
                        },
                        newCredit: {
                            validators: {
                                stringLength: {
                                    max: 3,
                                },
                                notEmpty: {
                                    message: 'โปรดระบุหน่วยกิตใหม่'
                                },
                                between: {
                                    min: 0,
                                    max: 9999,
                                    message: 'โปรดระบุเป็นตัวเลขที่ถูกต้อง'
                                }
                            }
                        },
                        goalGrade: {
                            validators: {
                                stringLength: {
                                    max: 4,
                                },
                                notEmpty: {
                                    message: 'โปรดระบุเกรดเฉลี่ยที่ต้องการ'
                                },
                                between: {
                                    min: 0,
                                    max: 4,
                                    message: 'ค่าสูงสุดของเกรด = 4'
                                }
                            }
                        }
                    },
                    submitHandler: function (validator, form, submitButton) {
                        home.saveProcess();
                    }
                })

                $("#btnReset").click(function() {
                    home.clearData();
                });
            },
            saveProcess: function () {

                var data = home.getData();
                data = home.calculateGrade(data);

                if (data.answerGrade > maxGrade) {
                    data = home.reCalculateGrade(data);
                }

                home.setData(data);

                return false;
            },
            clearData: function () {
                $('#success_message').slideUp({ opacity: "hide" }, "slow");
                $('#calGradeform').data('bootstrapValidator').resetForm();

                $("#lbSubject").text(data.subject);
                $("#lbGoalGrade").text(data.goalGrade);
                $("#lbResultGrade").text(data.resultGrade);
            },
            getData: function () {
                var data = {
                    subject: $("#subject").val(),//วิชา
                    allCredit: $("#allCredit").val() * 1.0,//หน่วยกิตเดิมทั้งหมด
                    avgGrade: $("#avgGrade").val() * 1.0,//เกรดเฉลี่ยเดิม
                    newCredit: $("#newCredit").val() * 1.0,//หน่วยกิตใหม่
                    goalGrade: $("#goalGrade").val() * 1.0,//เกรดเฉลี่ยที่ต้องการ                       
                };
                return data;
            },
            calculateGrade: function (data) {

                data.sumGrade = data.allCredit * data.avgGrade;//เกรดรวม
                data.newAvgGrade = (data.goalGrade * (data.allCredit + data.newCredit)) - data.sumGrade;//เกรดเฉลี่ยใหม่
                data.answerGrade = (data.newAvgGrade) / data.newCredit;//เกรดที่ต้องทำให้ได้
                data.answerGrade = data.answerGrade;
                data.resultGrade = home.calculateResultGrade(data.answerGrade);

                return data;
            },
            calculateResultGrade: function (answerGrade) {

                let floorVal = Math.floor(answerGrade);//เอาค่า floor เช่น 3.5 = 3
                let diffVal = answerGrade - floorVal; // เอาค่า diff เพื่อมา เทียบทศนิยม

                //เทียบ ทศนิยมว่าตกที่ range ไหน
                if (diffVal == 0 || diffVal == 0.5) return answerGrade;
                else if (diffVal < 0.5) answerGrade = floorVal + 0.5;
                else answerGrade = floorVal + 1;

                return answerGrade;
            },
            setData: function (data) {

                //วิชา
                $("#lbSubject").text(data.subject);

                //เกรดเฉลี่ยที่ต้องการ        
                if (data.answerGrade > maxGrade) {
                    data.goalGrade = data.goalGrade + " (สูงสุดที่สามารถทำได้)";
                }
                $("#lbGoalGrade").text(data.goalGrade);

                //เกรดที่ต้องทำ
                if (data.resultGrade < 0) {
                    data.resultGrade = "ไม่สามารถคำนวณเกรดได้ เนื่องจากมีค่า < 0";
                }
                else if (data.resultGrade > 0 && data.resultGrade < 1) {
                    data.resultGrade = 1;
                }
                else if (data.resultGrade < maxGrade) {
                    data.resultGrade = data.resultGrade + " หรือมากกว่านั้น";

                }
                $("#lbResultGrade").text(data.resultGrade);

                //แสดง success
                $('#success_message').slideDown({ opacity: "show" }, "slow");
                $("#btnSubmit").removeAttr('disabled');

                //Add to table
                home.insertData(data);
            },
            reCalculateGrade: function (data) {
                data.resultGrade = maxGrade; //กำหนดให้เกรดที่ทำได้สูงสุด = 4
                data.goalGrade = (data.sumGrade + (data.resultGrade * data.newCredit)) / (data.allCredit + data.newCredit);
                data.goalGrade = data.goalGrade.toFixed(2);
                return data;
            },
            insertData: function (data) {
                var row = "<tr>";
                row = row + "<td class='text-center'>" + data.subject + "</td>";
                row = row + "<td class='text-center'>" + data.allCredit + "</td>";
                row = row + "<td class='text-center'>" + data.avgGrade + "</td>";
                row = row + "<td class='text-center'>" + data.newCredit + "</td>";
                row = row + "<td class='text-center'>" + data.goalGrade + "</td>";
                row = row + "<td class='text-center'>" + data.resultGrade + "</td>";
                row = row + "<td class='text-center'><button class='btn btn-xs btn-danger' onclick='home.deleteData(this);' ><span class='glyphicon glyphicon-trash'></span> ลบ</button></td>";
                row = row + "</tr>";
                $("#tblData tbody").append(row);

                $("#divTable").show();
            },
            deleteData: function (r) {
                var row = r.parentNode.parentNode.rowIndex;
                document.getElementById("tblData").deleteRow(row);
            }
        };
        $(document).ready(function () {
            home.init();
        });
    </script>
</body>

</html>